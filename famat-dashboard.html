<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FAMAT — Competition Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════════
   ROOT VARIABLES
═══════════════════════════════════════════════ */
:root {
  --bg:      #060912;
  --bg2:     #0d1220;
  --bg3:     #141c2e;
  --bg4:     #1c2640;
  --gold:    #f0c040;
  --gold2:   #fad56a;
  --gold3:   rgba(240,192,64,0.12);
  --blue:    #4f8ef7;
  --blue2:   #7aabff;
  --green:   #34d399;
  --red:     #f87171;
  --amber:   #fb923c;
  --text:    #e8eaf2;
  --text2:   #9aa3bc;
  --text3:   #5a6480;
  --border:  rgba(240,192,64,0.18);
  --border2: rgba(255,255,255,0.06);
  --shadow:  0 20px 60px rgba(0,0,0,0.6);
  --radius:  3px;
  --mono:    'JetBrains Mono', monospace;
  --display: 'Crimson Pro', serif;
  --num:     'Bebas Neue', sans-serif;
}

/* ═══════════════════════════════════════════════
   RESET + BASE
═══════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Crimson Pro', serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 16px;
  line-height: 1.5;
}
button { cursor: pointer; font-family: inherit; }
input, select { font-family: inherit; }
a { color: inherit; text-decoration: none; }

/* scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg2); }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }

/* ═══════════════════════════════════════════════
   NOISE TEXTURE OVERLAY
═══════════════════════════════════════════════ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
  opacity: 0.4;
}

/* ═══════════════════════════════════════════════
   AUTH PAGE
═══════════════════════════════════════════════ */
#auth-page {
  display: none;
  min-height: 100vh;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
#auth-page.visible { display: flex; }

.auth-bg {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 60% at 15% 50%, rgba(240,192,64,0.07) 0%, transparent 70%),
    radial-gradient(ellipse 50% 80% at 85% 20%, rgba(79,142,247,0.05) 0%, transparent 60%),
    linear-gradient(160deg, #060912 0%, #0a1020 50%, #060912 100%);
}

.auth-grid {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(240,192,64,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(240,192,64,0.03) 1px, transparent 1px);
  background-size: 48px 48px;
}

/* big decorative number */
.auth-deco {
  position: absolute;
  font-family: var(--num);
  font-size: 40vw;
  color: rgba(240,192,64,0.015);
  line-height: 1;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  user-select: none;
  pointer-events: none;
  white-space: nowrap;
}

.auth-card {
  position: relative;
  width: 460px;
  max-width: 95vw;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0;
  box-shadow: var(--shadow), 0 0 100px rgba(240,192,64,0.06);
  overflow: hidden;
}

.auth-card-header {
  padding: 40px 44px 28px;
  border-bottom: 1px solid var(--border2);
  position: relative;
}

.auth-card-header::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 0%, var(--gold) 30%, var(--gold2) 50%, var(--gold) 70%, transparent 100%);
}

.auth-wordmark {
  font-family: var(--num);
  font-size: 42px;
  letter-spacing: 8px;
  color: var(--gold);
  line-height: 1;
  display: block;
}

.auth-sub {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--text3);
  text-transform: uppercase;
  margin-top: 6px;
}

.auth-tabs {
  display: flex;
  margin-top: 20px;
  gap: 0;
  background: var(--bg3);
  border-radius: 2px;
  padding: 3px;
}

.auth-tab {
  flex: 1;
  padding: 9px;
  background: none;
  border: none;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
  border-radius: 1px;
  transition: all 0.2s;
}
.auth-tab.active { background: var(--gold3); color: var(--gold); }

.auth-body { padding: 28px 44px 36px; }

.field { margin-bottom: 16px; }
.field label {
  display: block;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 7px;
}
.field input {
  width: 100%;
  padding: 12px 15px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--mono);
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.field input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(240,192,64,0.08);
}

.btn-gold {
  width: 100%;
  padding: 14px;
  background: var(--gold);
  border: none;
  border-radius: var(--radius);
  color: var(--bg);
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
  margin-top: 6px;
}
.btn-gold:hover { background: var(--gold2); box-shadow: 0 4px 20px rgba(240,192,64,0.3); }
.btn-gold:active { transform: scale(0.99); }
.btn-gold:disabled { opacity: 0.45; cursor: not-allowed; }

.auth-notice {
  margin-top: 14px;
  padding: 11px 14px;
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 12px;
  text-align: center;
  display: none;
  line-height: 1.5;
}
.auth-notice.err { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.25); color: var(--red); }
.auth-notice.ok  { background: rgba(52,211,153,0.08); border: 1px solid rgba(52,211,153,0.25); color: var(--green); }

/* ═══════════════════════════════════════════════
   TOP BAR
═══════════════════════════════════════════════ */
#app { display: none; min-height: 100vh; }

.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 56px;
  background: rgba(6,9,18,0.95);
  border-bottom: 1px solid var(--border2);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  z-index: 200;
}

.topbar-logo {
  font-family: var(--num);
  font-size: 24px;
  letter-spacing: 5px;
  color: var(--gold);
  display: flex;
  align-items: center;
  gap: 10px;
}

.topbar-logo .dot {
  width: 6px;
  height: 6px;
  background: var(--gold);
  border-radius: 50%;
  display: inline-block;
}

.topbar-center {
  display: flex;
  align-items: center;
  gap: 2px;
}

/* Division tabs in topbar */
.div-tab {
  padding: 7px 16px;
  background: none;
  border: none;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text3);
  border-radius: 2px;
  transition: all 0.15s;
  white-space: nowrap;
}
.div-tab:hover { color: var(--text2); background: var(--bg3); }
.div-tab.active { color: var(--gold); background: var(--gold3); }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.nav-pill {
  padding: 7px 14px;
  background: none;
  border: 1px solid var(--border2);
  border-radius: 2px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  transition: all 0.15s;
  white-space: nowrap;
}
.nav-pill:hover { color: var(--text); border-color: var(--text3); }
.nav-pill.active { color: var(--gold); border-color: var(--border); background: var(--gold3); }

.user-chip {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: none;
}

.btn-signout {
  padding: 6px 12px;
  background: none;
  border: 1px solid rgba(248,113,113,0.2);
  border-radius: 2px;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text3);
  transition: all 0.15s;
}
.btn-signout:hover { color: var(--red); border-color: rgba(248,113,113,0.5); }

/* ═══════════════════════════════════════════════
   MAIN LAYOUT
═══════════════════════════════════════════════ */
.main {
  padding-top: 56px;
  min-height: 100vh;
}

.view {
  display: none;
  padding: 32px 28px;
  max-width: 1600px;
  margin: 0 auto;
  animation: fadeUp 0.2s ease;
}
.view.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ═══════════════════════════════════════════════
   LOADING OVERLAY
═══════════════════════════════════════════════ */
.load-overlay {
  position: fixed;
  inset: 0;
  background: rgba(6,9,18,0.92);
  backdrop-filter: blur(6px);
  z-index: 500;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  display: none;
}
.load-overlay.show { display: flex; }

.load-wordmark {
  font-family: var(--num);
  font-size: 48px;
  letter-spacing: 8px;
  color: var(--gold);
}

.load-status {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
  letter-spacing: 1px;
  min-width: 280px;
  text-align: center;
}

.load-bar-track {
  width: 280px;
  height: 2px;
  background: var(--bg4);
  border-radius: 1px;
  overflow: hidden;
}
.load-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--gold2));
  border-radius: 1px;
  width: 0%;
  transition: width 0.3s ease;
}

/* ═══════════════════════════════════════════════
   PAGE HEADER
═══════════════════════════════════════════════ */
.page-hdr {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 16px;
}

.page-hdr-left h1 {
  font-family: var(--num);
  font-size: 44px;
  letter-spacing: 3px;
  color: var(--text);
  line-height: 1;
}

.page-hdr-left h1 em {
  font-style: normal;
  color: var(--gold);
}

.page-hdr-left p {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  letter-spacing: 1px;
  margin-top: 6px;
}

/* ═══════════════════════════════════════════════
   STAT CARDS ROW
═══════════════════════════════════════════════ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.sc {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s;
}
.sc:hover { border-color: var(--border); transform: translateY(-1px); }
.sc::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1.5px;
  background: linear-gradient(90deg, var(--gold), transparent);
  opacity: 0.5;
}
.sc-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 8px;
}
.sc-val {
  font-family: var(--num);
  font-size: 38px;
  color: var(--gold);
  line-height: 1;
  letter-spacing: 1px;
}
.sc-val.sm { font-size: 22px; }
.sc-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  margin-top: 4px;
}

/* ═══════════════════════════════════════════════
   TOOLBAR
═══════════════════════════════════════════════ */
.toolbar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}

.search-box {
  position: relative;
  flex: 1;
  min-width: 220px;
}
.search-box input {
  width: 100%;
  padding: 10px 14px 10px 38px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  outline: none;
  transition: border-color 0.2s;
}
.search-box input:focus { border-color: var(--gold); }
.search-box input::placeholder { color: var(--text3); }
.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 15px;
  color: var(--text3);
  pointer-events: none;
}

.sel {
  padding: 10px 12px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text2);
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
  cursor: pointer;
  min-width: 150px;
  transition: border-color 0.2s;
}
.sel:focus { border-color: var(--gold); }
.sel option { background: var(--bg2); }

.btn-sm {
  padding: 10px 16px;
  background: none;
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text3);
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-sm:hover { color: var(--gold); border-color: var(--border); }
.btn-sm.active { color: var(--gold); background: var(--gold3); border-color: var(--border); }

/* ═══════════════════════════════════════════════
   TABLE
═══════════════════════════════════════════════ */
.tbl-wrap {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  overflow: hidden;
}

.tbl-scroll { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

thead th {
  padding: 12px 16px;
  text-align: left;
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  background: linear-gradient(180deg, var(--bg3) 0%, var(--bg2) 100%);
  border-bottom: 1px solid var(--border2);
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  transition: color 0.15s;
}
thead th:hover { color: var(--gold); }
thead th.sorted { color: var(--gold); }

tbody tr {
  border-bottom: 1px solid rgba(255,255,255,0.03);
  cursor: pointer;
  transition: background 0.1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(240,192,64,0.04); }

tbody td {
  padding: 11px 16px;
  font-size: 14px;
}

.rank-num {
  font-family: var(--num);
  font-size: 20px;
  letter-spacing: 1px;
  line-height: 1;
}
.rank-1 { color: var(--gold); }
.rank-2 { color: #b0b8c8; }
.rank-3 { color: #cd7f32; }
.rank-n { color: var(--text3); }

.td-name {
  font-family: var(--display);
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
}

.td-school {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--blue2);
}

.td-score {
  font-family: var(--num);
  font-size: 22px;
  color: var(--gold2);
  letter-spacing: 1px;
}

.td-mono {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text2);
}

.td-green { color: var(--green); }
.td-red   { color: var(--red); }
.td-dim   { color: var(--text3); }

.td-acc {
  display: flex;
  align-items: center;
  gap: 8px;
}
.mini-bar {
  width: 50px;
  height: 3px;
  background: var(--bg4);
  border-radius: 2px;
  overflow: hidden;
  flex-shrink: 0;
}
.mini-bar-fill {
  height: 100%;
  background: var(--green);
  border-radius: 2px;
}

.tbl-footer {
  padding: 11px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid var(--border2);
  background: var(--bg3);
}
.tbl-info {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}

/* Pagination */
.pagination {
  display: flex;
  align-items: center;
  gap: 4px;
}
.pg-btn {
  padding: 5px 10px;
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: 2px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  transition: all 0.15s;
}
.pg-btn:hover:not(:disabled) { color: var(--gold); border-color: var(--border); }
.pg-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.pg-btn.cur { background: var(--gold3); color: var(--gold); border-color: var(--border); }
.pg-info { font-family: var(--mono); font-size: 11px; color: var(--text3); padding: 0 8px; }

/* empty/loading states */
.tbl-state {
  text-align: center;
  padding: 60px 20px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
}

.spin {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid var(--border2);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══════════════════════════════════════════════
   STUDENT PROFILE MODAL
═══════════════════════════════════════════════ */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(6,9,18,0.88);
  backdrop-filter: blur(8px);
  z-index: 400;
  display: none;
  align-items: flex-start;
  justify-content: center;
  padding: 40px 16px;
  overflow-y: auto;
}
.overlay.open { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 780px;
  max-width: 100%;
  position: relative;
  box-shadow: var(--shadow);
  animation: modalIn 0.2s ease;
  margin: auto;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.97) translateY(8px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.modal::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), var(--gold2), var(--gold), transparent);
}

.modal-hdr {
  padding: 28px 32px 20px;
  border-bottom: 1px solid var(--border2);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
}

.modal-close {
  background: none;
  border: 1px solid var(--border2);
  border-radius: 2px;
  color: var(--text3);
  font-size: 18px;
  padding: 4px 10px;
  line-height: 1;
  transition: all 0.15s;
  flex-shrink: 0;
}
.modal-close:hover { color: var(--red); border-color: rgba(248,113,113,0.4); }

.profile-hero {
  display: flex;
  align-items: flex-start;
  gap: 24px;
}

.profile-rank-badge {
  font-family: var(--num);
  font-size: 72px;
  line-height: 1;
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gold3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  flex-shrink: 0;
  letter-spacing: 2px;
}
.profile-rank-badge.r1 { color: var(--gold); }
.profile-rank-badge.r2 { color: #b0b8c8; background: rgba(176,184,200,0.08); border-color: rgba(176,184,200,0.2); }
.profile-rank-badge.r3 { color: #cd7f32; background: rgba(205,127,50,0.08); border-color: rgba(205,127,50,0.2); }
.profile-rank-badge.rn { color: var(--text3); background: var(--bg3); border-color: var(--border2); font-size: 48px; }

.profile-info { flex: 1; }
.profile-name {
  font-family: var(--display);
  font-size: 30px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.1;
  margin-bottom: 4px;
}
.profile-school {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--blue2);
  margin-bottom: 10px;
}
.profile-id {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}

/* profile stats grid */
.profile-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border2);
}

.ps {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 14px 12px;
  text-align: center;
}
.ps-val {
  font-family: var(--num);
  font-size: 30px;
  line-height: 1;
  margin-bottom: 4px;
  letter-spacing: 1px;
}
.ps-val.gold  { color: var(--gold); }
.ps-val.green { color: var(--green); }
.ps-val.red   { color: var(--red); }
.ps-val.blue  { color: var(--blue2); }
.ps-val.dim   { color: var(--text3); font-size: 22px; }
.ps-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
}

/* accuracy bar */
.acc-section {
  padding: 16px 32px;
  border-bottom: 1px solid var(--border2);
}
.acc-label {
  display: flex;
  justify-content: space-between;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  margin-bottom: 8px;
}
.acc-track {
  height: 6px;
  background: var(--bg4);
  border-radius: 3px;
  overflow: hidden;
}
.acc-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--green), #6ee7b7);
  transition: width 0.6s ease;
}

/* division breakdown */
.div-breakdown {
  padding: 20px 32px;
  border-bottom: 1px solid var(--border2);
}
.sec-title {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 14px;
}

.div-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.div-row:last-child { border-bottom: none; }
.div-row-name {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--gold);
  width: 140px;
  flex-shrink: 0;
}
.div-row-rank {
  font-family: var(--num);
  font-size: 22px;
  color: var(--text2);
  width: 50px;
  flex-shrink: 0;
  letter-spacing: 1px;
}
.div-row-score {
  font-family: var(--num);
  font-size: 22px;
  color: var(--gold2);
  width: 60px;
  flex-shrink: 0;
  letter-spacing: 1px;
}
.div-row-meta {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  flex: 1;
}
.div-row-acc {
  width: 80px;
  flex-shrink: 0;
}
.div-row-acc-label {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--green);
  margin-bottom: 4px;
  text-align: right;
}

/* mini chart */
.profile-chart {
  padding: 20px 32px;
}
.chart-mini { height: 140px; }

.modal-footer {
  padding: 16px 32px;
  border-top: 1px solid var(--border2);
  display: flex;
  gap: 10px;
  background: var(--bg3);
}

.btn-outline {
  padding: 11px 20px;
  background: none;
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text2);
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.15s;
}
.btn-outline:hover { color: var(--gold); border-color: var(--border); }

.btn-primary {
  padding: 11px 24px;
  background: var(--gold);
  border: none;
  border-radius: var(--radius);
  color: var(--bg);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  transition: background 0.15s;
}
.btn-primary:hover { background: var(--gold2); }

.btn-danger {
  padding: 11px 20px;
  background: none;
  border: 1px solid rgba(248,113,113,0.3);
  border-radius: var(--radius);
  color: var(--red);
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.15s;
}
.btn-danger:hover { background: rgba(248,113,113,0.08); }

/* ═══════════════════════════════════════════════
   EDIT MODAL
═══════════════════════════════════════════════ */
.edit-modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 560px;
  max-width: 100%;
  box-shadow: var(--shadow);
  animation: modalIn 0.2s ease;
  margin: auto;
}
.edit-modal::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--amber), transparent);
}

.eg {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  padding: 24px 32px;
}
.eg .field.full { grid-column: 1 / -1; }
.eg .field { margin-bottom: 0; }

/* ═══════════════════════════════════════════════
   ANALYTICS VIEW
═══════════════════════════════════════════════ */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 20px;
}
.chart-card {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 22px;
  transition: border-color 0.2s;
}
.chart-card:hover { border-color: var(--border); }
.chart-card.wide { grid-column: 1 / -1; }
.chart-card-title {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.chart-h { position: relative; height: 220px; }

.top-table { width: 100%; }
.top-table tr { border-bottom: 1px solid rgba(255,255,255,0.03); }
.top-table tr:last-child { border-bottom: none; }
.top-table td { padding: 8px 6px; font-size: 13px; }
.top-pos { font-family: var(--num); font-size: 18px; color: var(--gold); width: 28px; }
.top-name { font-family: var(--display); font-weight: 600; flex: 1; }
.top-school { font-family: var(--mono); font-size: 10px; color: var(--text3); display: block; }
.top-score { font-family: var(--num); font-size: 20px; color: var(--gold2); text-align: right; }

/* ═══════════════════════════════════════════════
   ADMIN VIEW
═══════════════════════════════════════════════ */
.admin-card {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 24px 28px;
  margin-bottom: 16px;
}
.admin-card-title {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 18px;
}
.admin-form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
.admin-notice {
  margin-top: 14px;
  padding: 11px 14px;
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 11px;
  display: none;
}
.admin-notice.err { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.25); color: var(--red); }
.admin-notice.ok  { background: rgba(52,211,153,0.08); border: 1px solid rgba(52,211,153,0.25); color: var(--green); }

/* ═══════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════ */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  padding: 13px 20px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text);
  z-index: 9000;
  transform: translateY(12px);
  opacity: 0;
  pointer-events: none;
  transition: all 0.25s;
  max-width: 320px;
  box-shadow: var(--shadow);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.ok  { border-color: rgba(52,211,153,0.4); color: var(--green); }
.toast.err { border-color: rgba(248,113,113,0.4); color: var(--red); }

/* ═══════════════════════════════════════════════
   RESPONSIVE
═══════════════════════════════════════════════ */
@media (max-width: 900px) {
  .topbar { padding: 0 14px; }
  .topbar-center { display: none; }
  .view { padding: 20px 14px; }
  .charts-grid { grid-template-columns: 1fr; }
  .chart-card.wide { grid-column: 1; }
  .profile-stats { grid-template-columns: repeat(2, 1fr); }
  .eg { grid-template-columns: 1fr; }
  .eg .field.full { grid-column: 1; }
  .admin-form-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════
     LOADING OVERLAY
════════════════════════════════════ -->
<div class="load-overlay" id="load-overlay">
  <div class="load-wordmark">FAMAT</div>
  <div class="load-bar-track"><div class="load-bar-fill" id="load-bar"></div></div>
  <div class="load-status" id="load-status">Initializing…</div>
</div>

<!-- ═══════════════════════════════════
     AUTH PAGE
════════════════════════════════════ -->
<div id="auth-page">
  <div class="auth-bg"></div>
  <div class="auth-grid"></div>
  <div class="auth-deco">∑</div>
  <div class="auth-card">
    <div class="auth-card-header">
      <span class="auth-wordmark">FAMAT</span>
      <div class="auth-sub">Competition Portal</div>
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-in"  onclick="switchAuthTab('in')">Sign In</button>
        <button class="auth-tab"        id="tab-up"  onclick="switchAuthTab('up')">Create Account</button>
      </div>
    </div>
    <div class="auth-body">
      <!-- sign in -->
      <div id="form-in">
        <div class="field"><label>Email</label><input type="email" id="in-email" placeholder="you@school.edu" onkeydown="if(event.key==='Enter')doSignIn()"/></div>
        <div class="field"><label>Password</label><input type="password" id="in-pass" placeholder="••••••••" onkeydown="if(event.key==='Enter')doSignIn()"/></div>
        <button class="btn-gold" id="in-btn" onclick="doSignIn()">Sign In</button>
      </div>
      <!-- sign up -->
      <div id="form-up" style="display:none">
        <div class="field"><label>Full Name</label><input type="text" id="up-name" placeholder="Your Name"/></div>
        <div class="field"><label>Email</label><input type="email" id="up-email" placeholder="you@school.edu"/></div>
        <div class="field"><label>Password</label><input type="password" id="up-pass" placeholder="Min 6 characters"/></div>
        <div class="field"><label>Confirm Password</label><input type="password" id="up-conf" placeholder="••••••••" onkeydown="if(event.key==='Enter')doSignUp()"/></div>
        <button class="btn-gold" id="up-btn" onclick="doSignUp()">Create Account</button>
      </div>
      <div class="auth-notice" id="auth-notice"></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════
     APP
════════════════════════════════════ -->
<div id="app">
  <header class="topbar">
    <div class="topbar-logo">
      <span class="dot"></span>
      FAMAT
    </div>
    <!-- Division tabs injected here -->
    <div class="topbar-center" id="div-tabs"></div>
    <div class="topbar-right">
      <button class="nav-pill active" id="nav-leaderboard" onclick="switchView('leaderboard',this)">Leaderboard</button>
      <button class="nav-pill" id="nav-analytics"   onclick="switchView('analytics',this)">Analytics</button>
      <button class="nav-pill" id="nav-admin"        onclick="switchView('admin',this)" style="display:none">Admin</button>
      <span class="user-chip" id="user-chip"></span>
      <button class="btn-signout" onclick="doSignOut()">Sign Out</button>
    </div>
  </header>

  <main class="main">

    <!-- ── LEADERBOARD VIEW ── -->
    <div class="view active" id="view-leaderboard">
      <div class="page-hdr">
        <div class="page-hdr-left">
          <h1 id="view-title">LEADERBOARD</h1>
          <p id="view-sub">Loading…</p>
        </div>
      </div>

      <div class="stats-row" id="div-stats"></div>

      <div class="toolbar">
        <div class="search-box">
          <span class="search-icon">⌕</span>
          <input type="text" id="search" placeholder="Search name, school, or student ID…" oninput="applyFilters()"/>
        </div>
        <select class="sel" id="school-sel" onchange="applyFilters()"><option value="">All Schools</option></select>
        <select class="sel" id="sort-sel" onchange="applyFilters()">
          <option value="rank-asc">Rank ↑</option>
          <option value="score-desc">Score ↓</option>
          <option value="score-asc">Score ↑</option>
          <option value="tscore-desc">T-Score ↓</option>
          <option value="name-asc">Name A–Z</option>
          <option value="acc-desc">Accuracy ↓</option>
        </select>
        <button class="btn-sm" id="tog-cols" onclick="toggleExtraCols()">More Cols</button>
      </div>

      <div class="tbl-wrap">
        <div class="tbl-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:64px">Rank</th>
                <th>Name</th>
                <th>School</th>
                <th style="width:90px">Score</th>
                <th class="extra-col" style="width:70px">Right</th>
                <th class="extra-col" style="width:70px">Wrong</th>
                <th class="extra-col" style="width:70px">Blank</th>
                <th style="width:90px">Accuracy</th>
                <th style="width:90px">T-Score</th>
                <th class="extra-col">Student ID</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="tbl-footer">
          <span class="tbl-info" id="tbl-info">—</span>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </div>

    <!-- ── ANALYTICS VIEW ── -->
    <div class="view" id="view-analytics">
      <div class="page-hdr">
        <div class="page-hdr-left">
          <h1><em>Analytics</em></h1>
          <p id="analytics-sub">Competition statistics and performance breakdown</p>
        </div>
      </div>

      <div class="stats-row" id="analytics-stats"></div>

      <div class="charts-grid">
        <div class="chart-card wide">
          <div class="chart-card-title">Score Distribution</div>
          <div class="chart-h"><canvas id="c-dist"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Avg Score by School (Top 15)</div>
          <div class="chart-h"><canvas id="c-schools"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Top 10 Students</div>
          <table class="top-table" id="top10-tbl"></table>
        </div>
      </div>
    </div>

    <!-- ── ADMIN VIEW ── -->
    <div class="view" id="view-admin">
      <div class="page-hdr">
        <div class="page-hdr-left">
          <h1><em>Admin</em> Panel</h1>
          <p>Manage accounts and portal access</p>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title">Create New User Account</div>
        <div class="admin-form-grid">
          <div class="field" style="margin:0"><label>Full Name</label><input type="text" id="a-name" placeholder="Full name"/></div>
          <div class="field" style="margin:0"><label>Email</label><input type="email" id="a-email" placeholder="user@school.edu"/></div>
          <div class="field" style="margin:0"><label>Password</label><input type="password" id="a-pass" placeholder="Min 6 chars"/></div>
          <button class="btn-primary" style="padding:12px 20px;white-space:nowrap" onclick="adminCreate()">Create</button>
        </div>
        <div class="admin-notice" id="a-notice"></div>
      </div>
    </div>

  </main>
</div>

<!-- ═══ PROFILE OVERLAY ═══ -->
<div class="overlay" id="profile-overlay">
  <div class="modal" id="profile-modal">
    <div class="modal-hdr">
      <div class="profile-hero" id="profile-hero"></div>
      <button class="modal-close" onclick="closeOverlay('profile-overlay')">✕</button>
    </div>
    <div class="profile-stats" id="profile-stats"></div>
    <div class="acc-section" id="profile-acc"></div>
    <div class="div-breakdown" id="profile-divs"></div>
    <div class="profile-chart" id="profile-chart" style="display:none">
      <div class="sec-title">Score Across Divisions</div>
      <div class="chart-mini"><canvas id="c-profile"></canvas></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="openEditFromProfile()">Edit Record</button>
      <button class="btn-danger"  onclick="deleteFromProfile()">Delete</button>
      <button class="btn-outline" onclick="closeOverlay('profile-overlay')">Close</button>
    </div>
  </div>
</div>

<!-- ═══ EDIT OVERLAY ═══ -->
<div class="overlay" id="edit-overlay">
  <div class="edit-modal modal" style="position:relative">
    <div class="modal-hdr">
      <div style="font-family:var(--num);font-size:26px;letter-spacing:2px">EDIT RECORD</div>
      <button class="modal-close" onclick="closeOverlay('edit-overlay')">✕</button>
    </div>
    <div class="eg">
      <div class="field full"><label>Full Name</label><input type="text" id="e-name"/></div>
      <div class="field"><label>Rank</label><input type="number" id="e-rank"/></div>
      <div class="field"><label>School</label><input type="text" id="e-school"/></div>
      <div class="field"><label>Score</label><input type="number" id="e-score" step="0.01"/></div>
      <div class="field"><label>T-Score</label><input type="number" id="e-tscore" step="0.01"/></div>
      <div class="field"><label>Right</label><input type="number" id="e-right"/></div>
      <div class="field"><label>Wrong</label><input type="number" id="e-wrong"/></div>
      <div class="field"><label>Blank</label><input type="number" id="e-blank"/></div>
      <div class="field"><label>Student ID</label><input type="text" id="e-sid"/></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="saveEdit()">Save Changes</button>
      <button class="btn-outline" onclick="closeOverlay('edit-overlay')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ═══════════════════════════════════
     JAVASCRIPT
════════════════════════════════════ -->
<script>
/* ─────────────────────────────────────────
   ⚙️  CONFIGURATION — ADD DIVISIONS HERE
   Add one object per Supabase table.
   label = display name  |  table = exact Supabase table name
────────────────────────────────────────── */
const DIVISIONS = [
  { label: 'Algebra 1', table: 'Algebra 1' },
  { label: 'Geometry',  table: 'Geometry'  },
  // { label: 'Algebra 2', table: 'Algebra 2' },
  // { label: 'Precalculus', table: 'Precalculus' },
  // { label: 'Calculus', table: 'Calculus' },
  // Add more divisions above this line
];

const SUPABASE_URL  = 'https://uyiqisqkyrgzpydmnhgj.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5aXFpc3FreXJnenB5ZG1uaGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDU5OTksImV4cCI6MjA4NzY4MTk5OX0.oIfviVmBrrWcIXzmW8uZWjmJDtwD2rf8m108z5m5iqc';

const ROWS_PER_PAGE = 100;

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

/* ── STATE ── */
let currentUser  = null;
let currentDiv   = DIVISIONS[0];   // active division object
let divData      = {};             // { tableName: [] } — cached data per division
let filtered     = [];             // current filtered+sorted rows
let curPage      = 1;
let currentStudent = null;         // student obj currently in profile modal
let extraCols    = false;
let analyticsBuilt = false;

/* ═══════════════════════════════════════
   INIT
═══════════════════════════════════════ */
window.addEventListener('DOMContentLoaded', async () => {
  const { data } = await sb.auth.getSession();
  if (data.session) {
    currentUser = data.session.user;
    initApp();
  } else {
    showAuth();
  }
});

/* ═══════════════════════════════════════
   AUTH
═══════════════════════════════════════ */
function showAuth() {
  document.getElementById('auth-page').classList.add('visible');
  document.getElementById('app').style.display = 'none';
}

function switchAuthTab(tab) {
  document.getElementById('form-in').style.display  = tab === 'in' ? 'block' : 'none';
  document.getElementById('form-up').style.display  = tab === 'up' ? 'block' : 'none';
  document.getElementById('tab-in').classList.toggle('active', tab === 'in');
  document.getElementById('tab-up').classList.toggle('active', tab === 'up');
  authNotice('', '');
}

function authNotice(msg, type) {
  const el = document.getElementById('auth-notice');
  el.textContent = msg;
  el.className = 'auth-notice' + (type ? ' ' + type : '');
  el.style.display = msg ? 'block' : 'none';
}

async function doSignIn() {
  const email = document.getElementById('in-email').value.trim();
  const pass  = document.getElementById('in-pass').value;
  if (!email || !pass) { authNotice('Enter email and password.', 'err'); return; }
  const btn = document.getElementById('in-btn');
  btn.disabled = true; btn.textContent = 'Signing in…';
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  btn.disabled = false; btn.textContent = 'Sign In';
  if (error) { authNotice(error.message, 'err'); return; }
  currentUser = data.user;
  initApp();
}

async function doSignUp() {
  const name = document.getElementById('up-name').value.trim();
  const email = document.getElementById('up-email').value.trim();
  const pass  = document.getElementById('up-pass').value;
  const conf  = document.getElementById('up-conf').value;
  if (!name || !email || !pass) { authNotice('All fields are required.', 'err'); return; }
  if (pass !== conf) { authNotice('Passwords do not match.', 'err'); return; }
  if (pass.length < 6) { authNotice('Password must be at least 6 characters.', 'err'); return; }
  const btn = document.getElementById('up-btn');
  btn.disabled = true; btn.textContent = 'Creating…';
  const { data, error } = await sb.auth.signUp({ email, password: pass, options: { data: { full_name: name } } });
  btn.disabled = false; btn.textContent = 'Create Account';
  if (error) { authNotice(error.message, 'err'); return; }
  if (data.session) { currentUser = data.user; initApp(); }
  else { authNotice('Account created! Check your email to confirm.', 'ok'); switchAuthTab('in'); }
}

async function doSignOut() {
  await sb.auth.signOut();
  currentUser = null; divData = {}; analyticsBuilt = false;
  showAuth();
}

/* ═══════════════════════════════════════
   APP INIT
═══════════════════════════════════════ */
function initApp() {
  document.getElementById('auth-page').classList.remove('visible');
  document.getElementById('app').style.display = 'block';
  document.getElementById('user-chip').textContent = currentUser.email;
  document.getElementById('user-chip').style.display = '';
  if ((currentUser.user_metadata || {}).is_admin) {
    document.getElementById('nav-admin').style.display = '';
  }
  buildDivTabs();
  loadDivision(DIVISIONS[0]);
}

/* ═══════════════════════════════════════
   DIVISION TABS
═══════════════════════════════════════ */
function buildDivTabs() {
  const container = document.getElementById('div-tabs');
  container.innerHTML = '';
  DIVISIONS.forEach((div, i) => {
    const btn = document.createElement('button');
    btn.className = 'div-tab' + (i === 0 ? ' active' : '');
    btn.textContent = div.label;
    btn.onclick = () => {
      document.querySelectorAll('.div-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadDivision(div);
    };
    container.appendChild(btn);
  });
}

/* ═══════════════════════════════════════
   FETCH ALL ROWS (handles 6000+ students)
   Supabase returns max 1000 per request —
   we loop until all pages are fetched.
═══════════════════════════════════════ */
async function fetchAllRows(tableName, onProgress) {
  const PAGE = 1000;
  let all = [];
  let from = 0;
  while (true) {
    if (onProgress) onProgress(all.length);
    const { data, error } = await sb
      .from(tableName)
      .select('*')
      .order('rank', { ascending: true })
      .range(from, from + PAGE - 1);
    if (error) { console.error('Fetch error:', error); break; }
    if (!data || data.length === 0) break;
    all = all.concat(data);
    if (data.length < PAGE) break;   // last page
    from += PAGE;
  }
  return all;
}

/* ═══════════════════════════════════════
   LOAD A DIVISION
═══════════════════════════════════════ */
async function loadDivision(div) {
  currentDiv = div;
  analyticsBuilt = false;
  curPage = 1;

  // Update title
  document.getElementById('view-title').textContent = div.label.toUpperCase();

  // If already cached, just render
  if (divData[div.table]) {
    renderDivision();
    return;
  }

  // Show loader
  const loader = document.getElementById('load-overlay');
  const bar    = document.getElementById('load-bar');
  const status = document.getElementById('load-status');
  loader.classList.add('show');
  status.textContent = `Loading ${div.label}…`;
  bar.style.width = '5%';

  try {
    const rows = await fetchAllRows(div.table, (loaded) => {
      const pct = Math.min(90, 5 + (loaded / 100));
      bar.style.width = pct + '%';
      status.textContent = `Loading ${div.label}… ${loaded.toLocaleString()} students`;
    });
    bar.style.width = '100%';
    divData[div.table] = rows;
    setTimeout(() => loader.classList.remove('show'), 300);
    renderDivision();
  } catch (e) {
    loader.classList.remove('show');
    toast('Failed to load ' + div.label + ': ' + e.message, 'err');
  }
}

/* ═══════════════════════════════════════
   RENDER DIVISION (table + stats)
═══════════════════════════════════════ */
function renderDivision() {
  const rows = divData[currentDiv.table] || [];

  // Populate school filter
  const schools = [...new Set(rows.map(r => r.school).filter(Boolean))].sort();
  const sel = document.getElementById('school-sel');
  const prev = sel.value;
  sel.innerHTML = '<option value="">All Schools</option>';
  schools.forEach(s => {
    const o = document.createElement('option');
    o.value = s; o.textContent = s;
    sel.appendChild(o);
  });
  if (prev && schools.includes(prev)) sel.value = prev;

  // Subtitle
  document.getElementById('view-sub').textContent =
    `${rows.length.toLocaleString()} students · ${schools.length} schools`;

  // Div stats
  renderDivStats(rows);

  applyFilters();
}

function renderDivStats(rows) {
  const scores = rows.map(r => r.score || 0).filter(x => x > 0);
  const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '—';
  const top = scores.length ? Math.max(...scores) : '—';
  const accs = rows.map(r => {
    const t = (r.right_count||0)+(r.wrong_count||0)+(r.blank_count||0);
    return t > 0 ? (r.right_count||0)/t*100 : null;
  }).filter(x => x !== null);
  const avgAcc = accs.length ? (accs.reduce((a,b)=>a+b,0)/accs.length).toFixed(1) : '—';

  document.getElementById('div-stats').innerHTML = `
    <div class="sc"><div class="sc-label">Students</div><div class="sc-val">${rows.length.toLocaleString()}</div></div>
    <div class="sc"><div class="sc-label">Schools</div><div class="sc-val">${new Set(rows.map(r=>r.school)).size}</div></div>
    <div class="sc"><div class="sc-label">Avg Score</div><div class="sc-val sm">${avg}</div></div>
    <div class="sc"><div class="sc-label">Top Score</div><div class="sc-val sm">${top}</div></div>
    <div class="sc"><div class="sc-label">Avg Accuracy</div><div class="sc-val sm">${avgAcc}%</div></div>
  `;
}

/* ═══════════════════════════════════════
   FILTER + SORT + PAGINATE
═══════════════════════════════════════ */
function applyFilters() {
  const q      = document.getElementById('search').value.toLowerCase();
  const school = document.getElementById('school-sel').value;
  const sort   = document.getElementById('sort-sel').value;
  const rows   = divData[currentDiv.table] || [];

  filtered = rows.filter(r => {
    const mq = !q ||
      (r.name||'').toLowerCase().includes(q) ||
      (r.school||'').toLowerCase().includes(q) ||
      (r.student_id||'').toLowerCase().includes(q);
    return mq && (!school || r.school === school);
  });

  filtered.sort((a, b) => {
    if (sort === 'rank-asc')    return (a.rank||9999)-(b.rank||9999);
    if (sort === 'score-desc')  return (b.score||0)-(a.score||0);
    if (sort === 'score-asc')   return (a.score||0)-(b.score||0);
    if (sort === 'tscore-desc') return (b.t_score||0)-(a.t_score||0);
    if (sort === 'name-asc')    return (a.name||'').localeCompare(b.name||'');
    if (sort === 'acc-desc') {
      const accA = calcAcc(a), accB = calcAcc(b);
      return accB - accA;
    }
    return 0;
  });

  curPage = 1;
  renderTable();
  renderPagination();
}

function calcAcc(r) {
  const t = (r.right_count||0)+(r.wrong_count||0)+(r.blank_count||0);
  return t > 0 ? (r.right_count||0)/t*100 : 0;
}

function rankClass(r) {
  if (r === 1) return 'rank-1';
  if (r === 2) return 'rank-2';
  if (r === 3) return 'rank-3';
  return 'rank-n';
}

/* ═══════════════════════════════════════
   RENDER TABLE
═══════════════════════════════════════ */
function renderTable() {
  const tbody = document.getElementById('tbody');
  const start = (curPage - 1) * ROWS_PER_PAGE;
  const page  = filtered.slice(start, start + ROWS_PER_PAGE);

  document.getElementById('tbl-info').textContent =
    `Showing ${(start+1).toLocaleString()}–${Math.min(start+ROWS_PER_PAGE, filtered.length).toLocaleString()} of ${filtered.length.toLocaleString()} students`;

  // Toggle extra cols visibility
  document.querySelectorAll('.extra-col').forEach(el => {
    el.style.display = extraCols ? '' : 'none';
  });

  if (!page.length) {
    tbody.innerHTML = `<tr><td colspan="10" class="tbl-state">No students found.</td></tr>`;
    return;
  }

  tbody.innerHTML = page.map(r => {
    const acc = calcAcc(r);
    const accPct = acc.toFixed(0);
    const rc = rankClass(r.rank);
    return `
    <tr onclick="openProfile(${r.id}, '${currentDiv.table}')">
      <td><span class="rank-num ${rc}">${r.rank ?? '—'}</span></td>
      <td class="td-name">${escHtml(r.name || '—')}</td>
      <td class="td-school">${escHtml(r.school || '—')}</td>
      <td class="td-score">${r.score ?? '—'}</td>
      <td class="td-mono td-green extra-col">${r.right_count ?? '—'}</td>
      <td class="td-mono td-red extra-col">${r.wrong_count ?? '—'}</td>
      <td class="td-mono td-dim extra-col">${r.blank_count ?? '—'}</td>
      <td>
        <div class="td-acc">
          <div class="mini-bar"><div class="mini-bar-fill" style="width:${accPct}%"></div></div>
          <span class="td-mono td-green">${accPct}%</span>
        </div>
      </td>
      <td class="td-mono" style="color:var(--gold2)">${r.t_score ?? '—'}</td>
      <td class="td-mono td-dim extra-col" style="font-size:11px">${escHtml(r.student_id || '—')}</td>
    </tr>`;
  }).join('');

  // Reapply extra-col visibility to new rows
  document.querySelectorAll('.extra-col').forEach(el => {
    el.style.display = extraCols ? '' : 'none';
  });
}

function renderPagination() {
  const total = Math.ceil(filtered.length / ROWS_PER_PAGE);
  const pg    = document.getElementById('pagination');
  if (total <= 1) { pg.innerHTML = ''; return; }

  let html = `<button class="pg-btn" onclick="goPage(${curPage-1})" ${curPage===1?'disabled':''}>‹</button>`;

  // Smart page number display
  const pages = [];
  if (total <= 7) {
    for (let i=1; i<=total; i++) pages.push(i);
  } else {
    pages.push(1);
    if (curPage > 3) pages.push('…');
    for (let i=Math.max(2,curPage-1); i<=Math.min(total-1,curPage+1); i++) pages.push(i);
    if (curPage < total-2) pages.push('…');
    pages.push(total);
  }

  pages.forEach(p => {
    if (p === '…') {
      html += `<span class="pg-info">…</span>`;
    } else {
      html += `<button class="pg-btn ${p===curPage?'cur':''}" onclick="goPage(${p})">${p}</button>`;
    }
  });

  html += `<button class="pg-btn" onclick="goPage(${curPage+1})" ${curPage===total?'disabled':''}>›</button>`;
  pg.innerHTML = html;
}

function goPage(n) {
  const total = Math.ceil(filtered.length / ROWS_PER_PAGE);
  if (n < 1 || n > total) return;
  curPage = n;
  renderTable();
  renderPagination();
  document.getElementById('view-leaderboard').scrollTop = 0;
  window.scrollTo({ top: 56, behavior: 'smooth' });
}

function toggleExtraCols() {
  extraCols = !extraCols;
  document.getElementById('tog-cols').classList.toggle('active', extraCols);
  document.querySelectorAll('.extra-col').forEach(el => {
    el.style.display = extraCols ? '' : 'none';
  });
}

/* ═══════════════════════════════════════
   STUDENT PROFILE
═══════════════════════════════════════ */
function openProfile(id, tableName) {
  const rows = divData[tableName] || [];
  const s = rows.find(r => r.id === id);
  if (!s) return;
  currentStudent = { ...s, _table: tableName };
  renderProfileModal(s);
  document.getElementById('profile-overlay').classList.add('open');
}

function renderProfileModal(s) {
  const total = (s.right_count||0)+(s.wrong_count||0)+(s.blank_count||0);
  const acc   = total > 0 ? Math.round((s.right_count||0)/total*100) : 0;
  const divLabel = DIVISIONS.find(d => d.table === currentStudent._table)?.label || currentStudent._table;

  // Hero
  const rn = s.rank || 0;
  const rClass = rn===1?'r1':rn===2?'r2':rn===3?'r3':'rn';
  document.getElementById('profile-hero').innerHTML = `
    <div class="profile-rank-badge ${rClass}">#${s.rank??'—'}</div>
    <div class="profile-info">
      <div class="profile-name">${escHtml(s.name||'Unknown')}</div>
      <div class="profile-school">${escHtml(s.school||'—')}</div>
      <div class="profile-id">
        <span style="color:var(--gold);margin-right:10px">${escHtml(divLabel)}</span>
        ID: ${escHtml(s.student_id||'—')}
      </div>
    </div>
  `;

  // Gather cross-division data for this student
  const crossDiv = gatherCrossDivData(s);

  // Stats
  const testsPlayed = crossDiv.length;
  const avgRank  = crossDiv.length ? Math.round(crossDiv.reduce((a,b)=>a+(b.rank||0),0)/crossDiv.length) : s.rank || '—';
  const avgScore = crossDiv.length ? (crossDiv.reduce((a,b)=>a+(b.score||0),0)/crossDiv.length).toFixed(1) : s.score || '—';
  const bestDiv  = crossDiv.length ? crossDiv.sort((a,b)=>(a.rank||999)-(b.rank||999))[0] : null;

  document.getElementById('profile-stats').innerHTML = `
    <div class="ps"><div class="ps-val gold">${s.score??'—'}</div><div class="ps-label">Score</div></div>
    <div class="ps"><div class="ps-val green">${s.right_count??'—'}</div><div class="ps-label">Right</div></div>
    <div class="ps"><div class="ps-val red">${s.wrong_count??'—'}</div><div class="ps-label">Wrong</div></div>
    <div class="ps"><div class="ps-val dim">${s.blank_count??'—'}</div><div class="ps-label">Blank</div></div>
    <div class="ps"><div class="ps-val blue">${testsPlayed}</div><div class="ps-label">Divisions</div></div>
    <div class="ps"><div class="ps-val gold">${avgScore}</div><div class="ps-label">Avg Score</div></div>
    <div class="ps"><div class="ps-val dim">${typeof avgRank === 'number' ? '#'+avgRank : avgRank}</div><div class="ps-label">Avg Rank</div></div>
    <div class="ps"><div class="ps-val green">${s.t_score??'—'}</div><div class="ps-label">T-Score</div></div>
  `;

  // Accuracy bar
  document.getElementById('profile-acc').innerHTML = `
    <div class="acc-label">
      <span>Answer Accuracy (${divLabel})</span>
      <span style="color:var(--green);font-family:var(--mono);font-size:13px">${acc}%</span>
    </div>
    <div class="acc-track"><div class="acc-fill" style="width:${acc}%"></div></div>
    <div style="display:flex;gap:24px;margin-top:12px;font-family:var(--mono);font-size:11px;color:var(--text3)">
      <span style="color:var(--green)">✓ ${s.right_count??0} correct</span>
      <span style="color:var(--red)">✗ ${s.wrong_count??0} wrong</span>
      <span style="color:var(--text3)">— ${s.blank_count??0} blank</span>
      <span>Total: ${total}</span>
    </div>
  `;

  // Cross-division breakdown
  const allDivRows = gatherCrossDivDataFull(s);
  let divHTML = `<div class="sec-title">Performance by Division</div>`;
  if (allDivRows.length === 0) {
    divHTML += `<div style="font-family:var(--mono);font-size:11px;color:var(--text3)">Only one division loaded. Load more divisions to see cross-division stats.</div>`;
  } else {
    allDivRows.forEach(d => {
      const da = d.total > 0 ? Math.round(d.right/d.total*100) : 0;
      divHTML += `
        <div class="div-row">
          <div class="div-row-name">${escHtml(d.divLabel)}</div>
          <div class="div-row-rank">#${d.rank??'—'}</div>
          <div class="div-row-score">${d.score??'—'}</div>
          <div class="div-row-meta">
            <span style="color:var(--green)">✓${d.right??'—'}</span>
            <span style="color:var(--red);margin:0 6px">✗${d.wrong??'—'}</span>
            <span style="color:var(--text3)">—${d.blank??'—'}</span>
          </div>
          <div class="div-row-acc">
            <div class="div-row-acc-label">${da}%</div>
            <div class="acc-track" style="height:3px"><div class="acc-fill" style="width:${da}%"></div></div>
          </div>
        </div>`;
    });
  }
  document.getElementById('profile-divs').innerHTML = divHTML;

  // Cross-division chart
  const chartDiv = document.getElementById('profile-chart');
  if (allDivRows.length > 1) {
    chartDiv.style.display = 'block';
    const old = Chart.getChart('c-profile');
    if (old) old.destroy();
    new Chart(document.getElementById('c-profile'), {
      type: 'bar',
      data: {
        labels: allDivRows.map(d => d.divLabel),
        datasets: [{
          data: allDivRows.map(d => d.score || 0),
          backgroundColor: 'rgba(240,192,64,0.25)',
          borderColor: 'rgba(240,192,64,0.8)',
          borderWidth: 1,
          borderRadius: 2,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#5a6480', font: { family: "'JetBrains Mono'" } }, grid: { color: 'rgba(255,255,255,0.04)' } },
          y: { ticks: { color: '#5a6480', font: { family: "'JetBrains Mono'" } }, grid: { color: 'rgba(255,255,255,0.04)' } }
        }
      }
    });
  } else {
    chartDiv.style.display = 'none';
  }
}

// Return entries for all loaded divisions that have this student (matched by student_id)
function gatherCrossDivDataFull(s) {
  const results = [];
  DIVISIONS.forEach(div => {
    if (!divData[div.table]) return;
    const match = divData[div.table].find(r =>
      r.student_id && s.student_id && r.student_id === s.student_id
    );
    if (match) {
      const t = (match.right_count||0)+(match.wrong_count||0)+(match.blank_count||0);
      results.push({
        divLabel: div.label,
        rank: match.rank,
        score: match.score,
        right: match.right_count,
        wrong: match.wrong_count,
        blank: match.blank_count,
        total: t,
      });
    }
  });
  return results;
}

function gatherCrossDivData(s) {
  if (!s.student_id) return [];
  const results = [];
  DIVISIONS.forEach(div => {
    if (!divData[div.table]) return;
    const m = divData[div.table].find(r => r.student_id === s.student_id);
    if (m) results.push(m);
  });
  return results;
}

function openEditFromProfile() {
  const s = currentStudent;
  document.getElementById('e-name').value   = s.name || '';
  document.getElementById('e-rank').value   = s.rank || '';
  document.getElementById('e-school').value = s.school || '';
  document.getElementById('e-score').value  = s.score || '';
  document.getElementById('e-tscore').value = s.t_score || '';
  document.getElementById('e-right').value  = s.right_count || '';
  document.getElementById('e-wrong').value  = s.wrong_count || '';
  document.getElementById('e-blank').value  = s.blank_count || '';
  document.getElementById('e-sid').value    = s.student_id || '';
  closeOverlay('profile-overlay');
  document.getElementById('edit-overlay').classList.add('open');
}

async function saveEdit() {
  const s = currentStudent;
  const updates = {
    name:        document.getElementById('e-name').value,
    rank:        parseInt(document.getElementById('e-rank').value) || null,
    school:      document.getElementById('e-school').value,
    score:       parseFloat(document.getElementById('e-score').value) || null,
    t_score:     parseFloat(document.getElementById('e-tscore').value) || null,
    right_count: parseInt(document.getElementById('e-right').value) || null,
    wrong_count: parseInt(document.getElementById('e-wrong').value) || null,
    blank_count: parseInt(document.getElementById('e-blank').value) || null,
    student_id:  document.getElementById('e-sid').value,
  };
  const { error } = await sb.from(s._table).update(updates).eq('id', s.id);
  if (error) { toast('Error: ' + error.message, 'err'); return; }
  // Update local cache
  const idx = (divData[s._table] || []).findIndex(r => r.id === s.id);
  if (idx !== -1) divData[s._table][idx] = { ...divData[s._table][idx], ...updates };
  analyticsBuilt = false;
  renderDivision();
  closeOverlay('edit-overlay');
  toast('Record saved ✓', 'ok');
}

async function deleteFromProfile() {
  const s = currentStudent;
  if (!confirm(`Delete ${s.name}? This cannot be undone.`)) return;
  const { error } = await sb.from(s._table).delete().eq('id', s.id);
  if (error) { toast('Error: ' + error.message, 'err'); return; }
  divData[s._table] = (divData[s._table] || []).filter(r => r.id !== s.id);
  analyticsBuilt = false;
  renderDivision();
  closeOverlay('profile-overlay');
  toast('Record deleted', 'ok');
}

/* ═══════════════════════════════════════
   ANALYTICS
═══════════════════════════════════════ */
function renderAnalytics() {
  const rows = divData[currentDiv.table] || [];
  if (!rows.length) return;

  const divLabel = currentDiv.label;
  document.getElementById('analytics-sub').textContent =
    `${divLabel} · ${rows.length.toLocaleString()} students · ${new Set(rows.map(r=>r.school)).size} schools`;

  const scores = rows.map(r => r.score||0).filter(x => x > 0);
  const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2) : 0;
  const maxS = scores.length ? Math.max(...scores) : 0;
  const minS = scores.length ? Math.min(...scores) : 0;
  const accs = rows.map(r => calcAcc(r));
  const avgAcc = accs.length ? (accs.reduce((a,b)=>a+b,0)/accs.length).toFixed(1) : 0;
  const totalRight = rows.reduce((a,r)=>a+(r.right_count||0),0);
  const totalWrong = rows.reduce((a,r)=>a+(r.wrong_count||0),0);

  document.getElementById('analytics-stats').innerHTML = `
    <div class="sc"><div class="sc-label">Students</div><div class="sc-val">${rows.length.toLocaleString()}</div></div>
    <div class="sc"><div class="sc-label">Schools</div><div class="sc-val">${new Set(rows.map(r=>r.school)).size}</div></div>
    <div class="sc"><div class="sc-label">Avg Score</div><div class="sc-val sm">${avg}</div></div>
    <div class="sc"><div class="sc-label">Score Range</div><div class="sc-val sm">${minS}–${maxS}</div></div>
    <div class="sc"><div class="sc-label">Avg Accuracy</div><div class="sc-val sm">${avgAcc}%</div></div>
    <div class="sc"><div class="sc-label">Total ✓ Answers</div><div class="sc-val sm">${totalRight.toLocaleString()}</div></div>
  `;

  buildAnalyticsCharts(rows);

  // Top 10
  const top10 = [...rows].sort((a,b)=>(b.score||0)-(a.score||0)).slice(0,10);
  document.getElementById('top10-tbl').innerHTML = top10.map((s,i) => `
    <tr>
      <td class="top-pos">${i+1}</td>
      <td><span class="top-name">${escHtml(s.name||'—')}<span class="top-school">${escHtml(s.school||'—')}</span></span></td>
      <td class="top-score">${s.score??'—'}</td>
    </tr>
  `).join('');
}

function buildAnalyticsCharts(rows) {
  const scores = rows.map(r=>r.score||0).filter(x=>x>=0);
  if (!scores.length) return;

  const mn = Math.floor(Math.min(...scores));
  const mx = Math.ceil(Math.max(...scores));
  const bk = Math.max(1, Math.round((mx-mn)/20));
  const buckets = {};
  for (let i=mn; i<=mx; i+=bk) buckets[i]=0;
  scores.forEach(sc => { const b=Math.floor(sc/bk)*bk; buckets[b]=(buckets[b]||0)+1; });

  ['c-dist','c-schools'].forEach(id => { const c=Chart.getChart(id); if(c) c.destroy(); });

  const gridC = 'rgba(255,255,255,0.04)';
  const tickC = '#5a6480';
  const monoFont = { family: "'JetBrains Mono'" };

  new Chart(document.getElementById('c-dist'), {
    type: 'bar',
    data: {
      labels: Object.keys(buckets),
      datasets: [{
        data: Object.values(buckets),
        backgroundColor: 'rgba(240,192,64,0.2)',
        borderColor: 'rgba(240,192,64,0.7)',
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: tickC, font: monoFont }, grid: { color: gridC } },
        y: { ticks: { color: tickC, font: monoFont }, grid: { color: gridC } }
      }
    }
  });

  // School averages
  const sm = {};
  rows.forEach(r => {
    if (!r.school) return;
    if (!sm[r.school]) sm[r.school] = [];
    sm[r.school].push(r.score||0);
  });
  const sa = Object.entries(sm)
    .map(([k,v]) => ({ school:k, avg:v.reduce((a,b)=>a+b,0)/v.length, count:v.length }))
    .sort((a,b) => b.avg-a.avg).slice(0,15);

  new Chart(document.getElementById('c-schools'), {
    type: 'bar',
    data: {
      labels: sa.map(s => s.school),
      datasets: [{
        data: sa.map(s => +s.avg.toFixed(2)),
        backgroundColor: 'rgba(79,142,247,0.2)',
        borderColor: 'rgba(79,142,247,0.7)',
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: tickC, font: monoFont }, grid: { color: gridC } },
        y: { ticks: { color: tickC, font: { ...monoFont, size: 10 } }, grid: { color: gridC } }
      }
    }
  });
}

/* ═══════════════════════════════════════
   ADMIN
═══════════════════════════════════════ */
async function adminCreate() {
  const name  = document.getElementById('a-name').value.trim();
  const email = document.getElementById('a-email').value.trim();
  const pass  = document.getElementById('a-pass').value;
  const n = document.getElementById('a-notice');
  n.style.display = 'none';
  if (!email || !pass) { n.textContent = 'Email and password required.'; n.className = 'admin-notice err'; n.style.display = 'block'; return; }
  const { error } = await sb.auth.signUp({ email, password: pass, options: { data: { full_name: name } } });
  if (error) { n.textContent = error.message; n.className = 'admin-notice err'; n.style.display = 'block'; return; }
  n.textContent = `✓ Account created for ${email}`;
  n.className = 'admin-notice ok'; n.style.display = 'block';
  document.getElementById('a-name').value = '';
  document.getElementById('a-email').value = '';
  document.getElementById('a-pass').value = '';
}

/* ═══════════════════════════════════════
   VIEW NAVIGATION
═══════════════════════════════════════ */
function switchView(view, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');
  if (btn) btn.classList.add('active');

  if (view === 'analytics') {
    if (!analyticsBuilt) { renderAnalytics(); analyticsBuilt = true; }
  }
}

/* ═══════════════════════════════════════
   OVERLAY HELPERS
═══════════════════════════════════════ */
function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.overlay.open').forEach(o => o.classList.remove('open'));
});

/* ═══════════════════════════════════════
   TOAST
═══════════════════════════════════════ */
function toast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

/* ═══════════════════════════════════════
   UTILS
═══════════════════════════════════════ */
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
</body>
</html>
